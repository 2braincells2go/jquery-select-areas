!function(e){e.imageArea=function(t,i){var a,s,o,n=t.options,r=t.$image,h=t.$trigger,c={},l=!0,u=!0,d=[0,0],g=[0,0],p={id:i,x:0,y:0,z:0,height:0,width:0},m=function(){p.z=0,M("blur")},f=function(){t.blurAll(),p.z=100,M()},w=function(){return p},v=function(e){r.trigger(e,[p.id,t.areas()])},y=function(e){var t=e||window.event||{};t.cancelBubble=!0,t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()},S=function(){e.each(arguments,function(e,t){A(t)})},A=function(t,i){var a,s;switch(t){case"start":a="mousedown",s="touchstart";break;case"move":a="mousemove",s="touchmove";break;case"stop":a="mouseup",s="touchend";break;default:return}i&&jQuery.isFunction(i)?e(window.document).on(a,i).on(s,i):e(window.document).off(a).off(s)},b=function(){a.css({cursor:"default",width:p.width,height:p.height,left:p.x,top:p.y,"z-index":p.z}),s.css({backgroundPosition:-p.x-1+"px "+(-p.y-1)+"px",cursor:n.allowMove?"move":"default",width:p.width-2>0?p.width-2:0,height:p.height-2>0?p.height-2:0,left:p.x+1,top:p.y+1,"z-index":p.z+2})},x=function(t){n.allowResize&&(t?e.each(c,function(e,t){var i,a,s=Math.round(t.width()/2),o=Math.round(t.height()/2),n=e[0],r=e[e.length-1];i="n"===n?-o:"s"===n?p.height-o-1:Math.round(p.height/2)-o-1,a="e"===r?p.width-s-1:"w"===r?-s:Math.round(p.width/2)-s-1,t.css({display:"block",left:p.x+a,top:p.y+i,"z-index":p.z+1})}):e(".select-areas-resize-handler").each(function(){e(this).css({display:"none"})}))},z=function(e){o&&o.css({display:e?"block":"none",left:p.x+p.width+1,top:p.y-o.outerHeight()-1,"z-index":p.z+1})},$=function(e){a.css({cursor:e}),s.css({cursor:e})},M=function(e){switch(e){case"startSelection":t._refresh(),b(),x(),z(!0);break;case"pickSelection":case"pickResizeHandler":x();break;case"resizeSelection":b(),x(),$("crosshair"),z(!0);break;case"moveSelection":b(),x(),$("move"),z(!0);break;case"blur":b(),x(),z();break;default:b(),x(!0),z(!0)}},_=function(e){y(e),p.width=n.minSize[0],p.height=n.minSize[1],f(),A("move",C),A("stop",I),g=O(e),g[0]+p.width>r.width()&&(g[0]=r.width()-p.width),g[1]+p.height>r.height()&&(g[1]=r.height()-p.height),p.x=g[0],p.y=g[1],M("startSelection")},k=function(e){y(e),f(),A("move",D),A("stop",I);var t=O(e);d[0]=t[0]-p.x,d[1]=t[1]-p.y,M("pickSelection")},R=function(e){y(e),f();var t=e.target.className.split(" ")[1];"w"===t[t.length-1]&&(g[0]+=p.width,p.x=g[0]-p.width),"n"===t[0]&&(g[1]+=p.height,p.y=g[1]-p.height),"n"===t||"s"===t?l=!1:("e"===t||"w"===t)&&(u=!1),A("move",C),A("stop",I),M("pickResizeHandler")},C=function(e){y(e),f();var t=O(e),i=t[1]-g[1],a=t[0]-g[0];Math.abs(a)<n.minSize[0]&&(a=a>=0?n.minSize[0]:-n.minSize[0]),Math.abs(i)<n.minSize[1]&&(i=i>=0?n.minSize[1]:-n.minSize[1]),(g[0]+a<0||g[0]+a>r.width())&&(a=-a),(g[1]+i<0||g[1]+i>r.height())&&(i=-i),n.maxSize[0]>n.minSize[0]&&n.maxSize[1]>n.minSize[1]&&(Math.abs(a)>n.maxSize[0]&&(a=a>=0?n.maxSize[0]:-n.maxSize[0]),Math.abs(i)>n.maxSize[1]&&(i=i>=0?n.maxSize[1]:-n.maxSize[1])),l&&(p.width=a),u&&(p.height=i),n.aspectRatio&&(a>0&&i>0||0>a&&0>i?l?i=Math.round(a/n.aspectRatio):a=Math.round(i*n.aspectRatio):l?i=-Math.round(a/n.aspectRatio):a=-Math.round(i*n.aspectRatio),g[0]+a>r.width()&&(a=r.width()-g[0],i=i>0?Math.round(a/n.aspectRatio):-Math.round(a/n.aspectRatio)),g[1]+i<0&&(i=-g[1],a=a>0?-Math.round(i*n.aspectRatio):Math.round(i*n.aspectRatio)),g[1]+i>r.height()&&(i=r.height()-g[1],a=a>0?Math.round(i*n.aspectRatio):-Math.round(i*n.aspectRatio)),p.width=a,p.height=i),p.width<0?(p.width=Math.abs(p.width),p.x=g[0]-p.width):p.x=g[0],p.height<0?(p.height=Math.abs(p.height),p.y=g[1]-p.height):p.y=g[1],v("changing"),M("resizeSelection")},D=function(e){y(e),f();var t=O(e);p.x=t[0]-d[0]>0?t[0]-d[0]+p.width<r.width()?t[0]-d[0]:r.width()-p.width:0,p.y=t[1]-d[1]>0?t[1]-d[1]+p.height<r.height()?t[1]-d[1]:r.height()-p.height:0,v("changing"),M("moveSelection")},I=function(e){y(e),S("move","stop"),g[0]=p.x,g[1]=p.y,l=!0,u=!0,v("changed"),M("releaseSelection")},j=function(n){y(n),s.remove(),a.remove(),e.each(c,function(e,t){t.remove()}),o.remove(),t._remove(i),v("changed")},E=function(t){var i=e(t).offset();return[i.left,i.top]},O=function(e){var t=E(r);e.pageX||(e.originalEvent&&(e=e.originalEvent),e.changedTouches&&(e=e.changedTouches[0]),e.touches&&(e=e.touches[0]));var i=e.pageX-t[0],a=e.pageY-t[1];return i=0>i?0:i>r.width()?r.width():i,a=0>a?0:a>r.height()?r.height():a,[i,a]};if(a=e('<div class="select-areas-outline" />').css({opacity:n.outlineOpacity,position:"absolute"}).insertAfter(h),s=e("<div />").addClass("select-areas-background-area").css({background:"url("+r.attr("src")+") no-repeat",backgroundSize:r.width()+"px",position:"absolute"}).insertAfter(a),n.allowResize&&e.each(["nw","n","ne","e","se","s","sw","w"],function(t,i){c[i]=e('<div class="select-areas-resize-handler '+i+'"/>').css({opacity:.5,position:"absolute",cursor:i+"-resize"}).insertAfter(s).mousedown(R).bind("touchstart",R)}),n.allowDelete){var H=function(e){return e.click(j).bind("touchstart",j).bind("tap",j),e};o=H(e('<div class="delete-area" />')).append(H(e('<div class="select-areas-delete-area" />'))).insertAfter(s)}return n.allowMove&&s.mousedown(k).bind("touchstart",k),f(),{getData:w,startSelection:_,deleteSelection:j,options:n,blur:m,focus:f,set:function(t){p=e.extend(p,t),v("changed")},contains:function(e){return e.x>=p.x&&e.x<=p.x+p.width&&e.y>=p.y&&e.y<=p.y+p.height}}},e.imageSelectAreas=function(){},e.imageSelectAreas.prototype.init=function(t,i){var a=this,s={allowEdit:!0,allowMove:!0,allowResize:!0,allowSelect:!0,allowDelete:!0,aspectRatio:0,minSize:[0,0],maxSize:[0,0],width:0,maxAreas:0,outlineOpacity:.5,overlayOpacity:.5,areas:[],onChanging:null,onChanged:null};this.options=e.extend(s,i),this.options.allowEdit||(this.options.allowSelect=this.options.allowMove=this.options.allowResize=this.options.allowDelete=!1),this._areas={},this.$image=e(t),this.ratio=1,this.options.width&&this.$image.width()&&this.options.width!==this.$image.width()&&(this.ratio=this.options.width/this.$image.width(),this.$image.width(this.options.width)),this.options.onChanging&&this.$image.on("changing",this.options.onChanging),this.options.onChanged&&this.$image.on("changed",this.options.onChanged),this.$holder=e("<div />").css({position:"relative",width:this.$image.width(),height:this.$image.height()}),this.$image.wrap(this.$holder).css({position:"absolute"}),this.$overlay=e('<div class="select-areas-overlay" />').css({opacity:this.options.overlayOpacity,position:"absolute",width:this.$image.width(),height:this.$image.height()}).insertAfter(this.$image),this.$trigger=e("<div />").css({backgroundColor:"#000000",opacity:0,position:"absolute",width:this.$image.width(),height:this.$image.height()}).insertAfter(this.$overlay),e.each(this.options.areas,function(e,t){a.add(t)}),this.blurAll(),this._refresh(),this.options.allowSelect&&this.$trigger.mousedown(e.proxy(this.newArea,this)).on("touchstart",e.proxy(this.newArea,this))},e.imageSelectAreas.prototype._refresh=function(){var e=this.areas().length;this.$overlay.css({display:e?"block":"none"}),e?this.$image.addClass("blurred"):this.$image.removeClass("blurred"),this.$trigger.css({cursor:this.options.allowSelect?"crosshair":"default"})},e.imageSelectAreas.prototype._eachArea=function(t){e.each(this._areas,function(e,i){return i?t(i,e):void 0})},e.imageSelectAreas.prototype._remove=function(e){delete this._areas[e],this._refresh()},e.imageSelectAreas.prototype.remove=function(e){this._areas[e]&&this._areas[e].deleteSelection()},e.imageSelectAreas.prototype.newArea=function(t){var i=-1;return this.blurAll(),this.options.maxAreas&&this.options.maxAreas<=this.areas().length?i:(this._eachArea(function(e,t){i=Math.max(i,parseInt(t,10))}),i+=1,this._areas[i]=e.imageArea(this,i),t&&this._areas[i].startSelection(t),i)},e.imageSelectAreas.prototype.set=function(e,t){this._areas[e]&&(t.id=e,this._areas[e].set(t),this._areas[e].focus())},e.imageSelectAreas.prototype._add=function(e){var t=this.newArea();this.set(t,e)},e.imageSelectAreas.prototype.add=function(t){var i=this;this.blurAll(),e.isArray(t)?e.each(t,function(e,t){i._add(t)}):this._add(t),this._refresh()},e.imageSelectAreas.prototype.reset=function(){var e=this;this._eachArea(function(t,i){e.remove(i)}),this._refresh()},e.imageSelectAreas.prototype.destroy=function(){this.reset(),this.$holder.remove(),this.$overlay.remove(),this.$trigger.remove(),this.$image.css("width","").css("position","").unwrap(),this.$image.removeData("mainImageSelectAreas")},e.imageSelectAreas.prototype.areas=function(){var e=[];return this._eachArea(function(t){e.push(t.getData())}),e},e.imageSelectAreas.prototype.relativeAreas=function(){for(var t=this.areas(),i=[],a=this.ratio,s=function(e){return Math.floor(e/a)},o=0;o<t.length;o++)i[o]=e.extend({},t[o]),i[o].x=s(i[o].x),i[o].y=s(i[o].y),i[o].width=s(i[o].width),i[o].height=s(i[o].height);return i},e.imageSelectAreas.prototype.blurAll=function(){this._eachArea(function(e){e.blur()})},e.imageSelectAreas.prototype.contains=function(e){var t=!1;return this._eachArea(function(i){return i.contains(e)?(t=!0,!1):void 0}),t},e.selectAreas=function(t,i){var a=e(t);if(!a.data("mainImageSelectAreas")){var s=new e.imageSelectAreas;s.init(t,i),a.data("mainImageSelectAreas",s)}return a.data("mainImageSelectAreas")},e.fn.selectAreas=function(t){return e.imageSelectAreas.prototype[t]?e.imageSelectAreas.prototype[t].apply(e.selectAreas(this),Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.selectAreas"):(this.each(function(){var i=this,a=new Image;a.onload=function(){e.selectAreas(i,t)},a.src=i.src}),this)}}(jQuery);
